<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SOGA | Sign Up</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=Roboto+Mono:wght@400;500;700&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --primary-color: #0f0f0f;
      --text-color: #101827;
      --bg-color: #f5f3ef;
      --secondary-bg: #e9e5dc;
      --accent-color: #ff7500;
      --button-bg: #1a1a1a;
      --orange-accent: #ff7500;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Inter', sans-serif;
      color: var(--text-color);
      background-color: var(--bg-color);
      line-height:1.6;
      background-image: url("data:image/svg+xml,%3Csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3E%3Cdefs%3E%3Cpattern id='grid' width='100' height='100' patternUnits='userSpaceOnUse'%3E%3Cpath d='M100 0 L0 0 0 100' fill='none' stroke='%23e0dcd4' stroke-width='0.5'/ %3E%3C/pattern%3E%3C/defs%3E%3Crect width='100%25' height='100%25' fill='url(%23grid)'/%3E%3C/svg%3E");
      background-attachment:fixed;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    .container { max-width:1200px; margin:0 auto; padding:0 2rem; }
    header { padding:1.5rem 0; background-color:var(--bg-color); width: 100%; position: absolute; top: 0; left: 0;}
    nav { display:flex; justify-content:space-between; align-items:center; max-width: 1200px; margin: 0 auto; padding: 0 2rem;}
    .logo { display:flex; align-items:center; }
    .logo img { height:30px; }
    .logo-text { font-weight:800; font-size:1.5rem; letter-spacing:-0.01em; margin-left:0.5rem; }
    .nav-links { display:flex; gap:2rem; }
    .nav-links a {
      text-decoration:none; color:var(--text-color); font-weight:500;
      font-size:0.9rem; letter-spacing:0.5px; text-transform:uppercase;
      padding:8px 12px; border-radius:6px; transition:all .3s ease;
    }
    .nav-links a:hover {
      background-color:rgba(255,117,0,0.1);
      color:var(--orange-accent);
      transform:translateY(-2px);
    }
    .auth-buttons { display:flex; gap:1rem; }
    .button {
      display:inline-flex; align-items:center; justify-content:center;
      background-color:var(--button-bg); color:white;
      padding:.6rem 1.2rem; border-radius:8px; font-weight:600;
      text-decoration:none; transition:all .3s ease; font-size:.85rem; letter-spacing:.5px;
    }
     .button.login { background:transparent; color:var(--button-bg); border:1px solid transparent; }
     .button.signup { background-color:var(--button-bg); }
    .button:hover {
      transform:translateY(-2px); box-shadow:0 5px 15px rgba(0,0,0,0.1);
    }
    .arrow { margin:0 .5rem; display:inline-block; transition:transform .3s ease; }
    .button:hover .arrow:first-child { transform:translateX(-3px); }
    .button:hover .arrow:last-child  { transform:translateX(3px); }

    .hero {
      padding:8rem 0 6rem; text-align:center; position:relative;
    }
    .background-globe {
      position:absolute; width:100%; height:100%; top:0; left:0;
      z-index:-1; opacity:0.3; pointer-events:none;
    }
    .globe-circle {
      position:absolute; border:1px solid #e0dcd4; border-radius:50%;
    }
    .globe-circle:nth-child(1){width:700px;height:700px;top:50%;left:50%;transform:translate(-50%,-50%);}
    .globe-circle:nth-child(2){width:900px;height:900px;top:50%;left:50%;transform:translate(-50%,-50%);}
    .globe-circle:nth-child(3){width:1100px;height:1100px;top:50%;left:50%;transform:translate(-50%,-50%);}
    .globe-line { position:absolute; height:1px; width:100%; background-color:#e0dcd4; top:50%; transform-origin:center; }
    .globe-line:nth-child(4){transform:rotate(30deg);} .globe-line:nth-child(5){transform:rotate(60deg);}
    .globe-line:nth-child(6){transform:rotate(90deg);} .globe-line:nth-child(7){transform:rotate(120deg);}
    .globe-line:nth-child(8){transform:rotate(150deg);}

    .auth-container {
      background:var(--secondary-bg); border-radius:12px; overflow:hidden;
      box-shadow:0 5px 15px rgba(0,0,0,0.05); max-width:900px; margin:40px auto;
    }
    .split-layout { display:flex; min-height:500px; }
    .auth-section { flex:1; padding:2.5rem; }
    .email-section { border-right:1px solid #ccc; background:var(--secondary-bg); }
    .social-section {
      background:var(--secondary-bg); display:flex; flex-direction:column;
      justify-content:center; align-items:center; text-align:center;
    }
    .auth-heading {
      font-size:2rem; font-weight:900; text-transform:uppercase;
      letter-spacing:-0.025em; margin-bottom:1rem; color:var(--text-color);
      text-align:center;
    }
    .auth-subheading {
      color:#4b5563; margin-bottom:2rem; text-align:center;
    }
    .auth-form .form-group { margin-bottom:1.5rem; }
    .auth-form input {
      width:100%; padding:.8rem; border:1px solid #ccc;
      border-radius:6px; font-size:.95rem; font-family:'Roboto Mono',monospace;
    }
    .btn-primary {
      width:100%; padding:.8rem; background-color:var(--button-bg);
      color:white; border:none; border-radius:8px; font-weight:600;
      cursor:pointer; transition:all .3s ease; font-size:.9rem;
    }
    .btn-primary:hover { transform:translateY(-2px); box-shadow:0 5px 15px rgba(0,0,0,0.15); }
    .google-auth {
      display:inline-flex; align-items:center; justify-content:center;
      background:#ffffff; border:1px solid rgba(255,255,255,0.8);
      color:var(--primary-color); padding:.8rem 1.2rem; border-radius:8px;
      font-weight:700; text-transform:uppercase; letter-spacing:-0.02em;
      cursor:pointer; transition:all .3s ease; font-size:1rem; margin-bottom:1rem;
    }
    .social-description { font-size:.85rem; color:#6b7280; max-width:80%; }
    .auth-footer { text-align:center; margin-top:1rem; font-size:.9rem; }
    .auth-footer a { color:var(--accent-color); text-decoration:none; }
    .message { padding:1rem; border-radius:8px; margin-bottom:1rem; }
    .message.success { background:#d4edda; color:#155724; }
    .message.error   { background:#f8d7da; color:#721c24; }
    #authMessage { display:none; padding:0 2.5rem; }
    .modal { display:none; position:fixed; top:0;left:0;width:100%;height:100%;
      background:rgba(0,0,0,0.7); z-index:1000; justify-content:center;align-items:center;
    }
    .modal-content { background:white; padding:2rem; border-radius:8px;
      max-width:500px; width:90%; text-align:center; box-shadow:0 5px 15px rgba(0,0,0,0.3);
    }
    .modal-buttons { display:flex; justify-content:center; gap:1rem; margin-top:1.5rem; }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <nav>
        <div class="logo">
          <img src="logo.png" alt="SOGA Logo"><span class="logo-text">SOGA</span>
        </div>
        <div class="nav-links">
          <a href="dashboard.html">DASHBOARD</a>
          <a href="messages.html">MESSAGES</a>
          <a href="groups.html">GROUPS</a>
          <a href="friends.html">FRIENDS</a>
          <a href="help.html">HELP</a>
        </div>
        <div class="auth-buttons">
          <a href="login.html" class="button login"><span class="arrow">›</span> LOGIN <span class="arrow">‹</span></a>
          <a href="signup.html" class="button signup"><span class="arrow">›</span> SIGN UP <span class="arrow">‹</span></a>
        </div>
      </nav>
    </div>
  </header>

  <section class="hero">
    <div class="background-globe">
      <div class="globe-circle"></div>
      <div class="globe-circle"></div>
      <div class="globe-circle"></div>
      <div class="globe-line"></div>
      <div class="globe-line"></div>
      <div class="globe-line"></div>
      <div class="globe-line"></div>
      <div class="globe-line"></div>
    </div>
    <div class="container">
      <h1 class="auth-heading">Sign Up to SOGA</h1>
      <div id="authMessage"></div>
      <div class="auth-container">
        <div class="split-layout">
          <div class="auth-section email-section">
            <h2 class="auth-heading">Sign up with Email</h2>
            <p class="auth-subheading">Create a new account using your email address</p>
            <form id="signupForm" class="auth-form">
              <div class="form-group">
                <input type="email" id="signupEmail" placeholder="Email" required autocomplete="username">
              </div>
              <div class="form-group">
                <input type="password" id="signupPassword" placeholder="Password" required autocomplete="new-password" minlength="6">
              </div>
              <div class="form-group">
                <input type="password" id="signupConfirmPassword" placeholder="Confirm Password" required autocomplete="new-password">
              </div>
              <div class="form-group">
                <input type="text" id="signupUsername" placeholder="Username" required minlength="4" maxlength="16">
                <p class="username-helper-text">Username must be 4–16 characters</p>
              </div>
              <button type="submit" class="btn-primary">Sign Up</button>
            </form>
            <p class="auth-footer">Already have an account? <a href="login.html">Login</a></p>
          </div>
          <div class="auth-section social-section">
            <h2 class="auth-heading">Sign up with Google</h2>
            <p class="auth-subheading">Quick and secure registration with your Google account</p>
            <button id="googleSignupBtn" class="google-auth">
              <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google logo" style="width:18px;height:18px;margin-right:10px;">
              Sign Up with Google
            </button>
            <p class="social-description">Using Google Sign‑Up lets you create your SOGA account without remembering another password.</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <div id="verificationModal" class="modal">
    <div class="modal-content">
      <h2>Verify Your Email</h2>
      <p>We've sent a verification email to <strong><span id="verificationEmail"></span></strong>.</p>
      <p>Please check your inbox and click the verification link to activate your account.</p>
      <div class="modal-buttons">
        <button id="resendVerificationBtn" class="button secondary">Resend Email</button>
        <button id="closeModalBtn" class="button signup">OK</button>
      </div>
    </div>
  </div>

  <footer style="text-align:center;padding:20px;color:#666;font-size:14px;">
    © 2025 SOGA
  </footer>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="firebase.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      // Initialize Firebase services
      await new Promise(r => {
        const iv = setInterval(() => {
          if (firebase.apps.length) { clearInterval(iv); r(); }
        }, 100);
      });
      const auth = firebase.auth();
      const db   = firebase.firestore();

      const signupForm = document.getElementById('signupForm');
      const authMessage = document.getElementById('authMessage');
      const usernameInput = document.getElementById('signupUsername');
      const usernameHelperText = document.querySelector('.username-helper-text');
      const verificationModal = document.getElementById('verificationModal');
      const verificationEmail = document.getElementById('verificationEmail');
      const resendVerificationBtn = document.getElementById('resendVerificationBtn');
      const closeModalBtn = document.getElementById('closeModalBtn');
      const googleSignupBtn = document.getElementById('googleSignupBtn');

       // Define a date before which verification is not required (optional, from previous snippet)
      const VERIFICATION_REQUIREMENT_DATE = new Date('2025-05-09').getTime(); // Using a future date to ensure new users need verification

       // Function to show messages
       function showMessage(msg, type) {
        authMessage.innerHTML = `<div class="message ${type}">${msg}</div>`;
        authMessage.style.display = 'block';
        authMessage.scrollIntoView({ behavior: 'smooth' });
      }
      function handleAuthError(err) {
        let msg = err.message;
        if (err.code === 'auth/email-already-in-use') msg = 'This email is already registered. Please login instead.';
        else if (err.code === 'auth/invalid-email') msg = 'Please enter a valid email address.';
        else if (err.code === 'auth/weak-password') msg = 'Password must be at least 6 characters.';
        showMessage(msg, 'error');
      }

      function validateUsername(un) {
        if (un.length < 4) return {valid:false, message:'Username must be at least 4 characters'};
        if (un.length > 16) return {valid:false, message:'Username cannot exceed 16 characters'};
        return {valid:true};
      }

      async function checkUsernameExists(un) {
        const snap = await db.collection('usernames').doc(un.toLowerCase()).get();
        return snap.exists;
      }

      function generateUsernameFromGoogle(user) {
        let base = (user.displayName||user.email.split('@')[0]).replace(/[^a-zA-Z0-9]/g,'').toLowerCase();
        if (base.length<4) base += '0000'.slice(0,4-base.length);
        if (base.length>16) base = base.slice(0,16);
        return base;
      }

       // Function to save user data to 'users' collection (intended to be called AFTER verification or for verified signups like Google)
       async function saveUserDataToUsers(user, username) {
            const userRef = db.collection('users').doc(user.uid);
            const timestamp = firebase.firestore.FieldValue.serverTimestamp();

            // Use set with merge: true in case a minimal document was created earlier (e.g., by auth state listener)
            await userRef.set({
                uid: user.uid, // Redundant but can be helpful
                email: user.email,
                username: username ? username.toLowerCase() : null, // Save username if provided
                emailVerified: user.emailVerified,
                requiresVerification: !user.emailVerified,
                createdAt: (await userRef.get()).data()?.createdAt || timestamp, // Keep original createdAt if exists
                updatedAt: timestamp // Add an update timestamp
            }, { merge: true });
       }

        // Function to save username mapping to 'usernames' collection (called immediately to reserve)
       async function saveUsernameMapping(username, uid) {
            const usernameRef = db.collection('usernames').doc(username.toLowerCase());
            const timestamp = firebase.firestore.FieldValue.serverTimestamp();
             await usernameRef.set({
                uid: uid,
                createdAt: timestamp // Optional timestamp
            });
       }


      // Username live validation
      usernameInput.addEventListener('input', async () => {
        const un = usernameInput.value.trim();
        const v = validateUsername(un);
        if (!v.valid) {
          usernameHelperText.textContent = v.message;
          usernameHelperText.classList.add('error');
        } else {
          usernameHelperText.textContent = 'Username looks good';
          usernameHelperText.classList.remove('error');
        }
      });

      // EMAIL SIGNUP
      signupForm.addEventListener('submit', async e => {
        e.preventDefault();
        authMessage.style.display='none';
        const email = document.getElementById('signupEmail').value;
        const pw = document.getElementById('signupPassword').value;
        const conf = document.getElementById('signupConfirmPassword').value;
        const un = usernameInput.value.trim();

        if (pw!==conf) { showMessage('Passwords do not match','error'); return; }
        const uv = validateUsername(un);
        if (!uv.valid) { showMessage(uv.message,'error'); return; }
        if (await checkUsernameExists(un)) { showMessage('Username taken','error'); return; }

        try {
          const { user } = await auth.createUserWithEmailAndPassword(email,pw);

          // Save the username mapping immediately to reserve the username
          await saveUsernameMapping(un, user.uid);

          // Send email verification
          await user.sendEmailVerification();

          // Do NOT save full user data (including username) to 'users' yet for email/password.
           // It will be saved in the onAuthStateChanged listener AFTER verification.
            // Optionally, save a minimal user document here to mark existence
             await db.collection('users').doc(user.uid).set({
                 uid: user.uid,
                 email: user.email,
                 createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                 emailVerified: user.emailVerified, // This will be false initially
                 requiresVerification: true
             }, { merge: true }); // Use merge: true

          verificationEmail.textContent = email;
          verificationModal.style.display='flex';
          showMessage('Created! Check your email to verify.','success');
        } catch(err) { handleAuthError(err); }
      });

      // RESEND / CLOSE modal
      resendVerificationBtn.onclick = async () => {
        if(auth.currentUser){
          try { await auth.currentUser.sendEmailVerification(); showMessage('Verification email resent','success'); }
          catch(e){ handleAuthError(e); }
        } else showMessage('Sign in again to resend.','warning');
      };
      closeModalBtn.onclick = () => {
        verificationModal.style.display='none';
        window.location.href='login.html';
      };

      // GOOGLE SIGNUP
      googleSignupBtn.addEventListener('click', async () => {
        authMessage.style.display='none';
        try {
          const provider = new firebase.auth.GoogleAuthProvider();
          provider.setCustomParameters({ prompt:'select_account' });
          const res = await auth.signInWithPopup(provider);
          const user = res.user;

          if (res.additionalUserInfo.isNewUser) {
            let un = generateUsernameFromGoogle(user), base=un, i=1;
            while (await checkUsernameExists(un)) {
              un = (base+ i).slice(0,16); i++;
            }
            await saveUsernameMapping(un, user.uid); // Save mapping immediately

            // Save full user data to 'users' collection immediately for new Google signups
            // as Google provides verified emails.
            await saveUserDataToUsers(user, un); // Save to users with username

            showMessage('Account created! Redirecting…','success');
          } else {
            // For existing users, just update their last login and verification status in 'users'
             await db.collection('users').doc(user.uid).set({
                 emailVerified: user.emailVerified,
                 requiresVerification: !user.emailVerified,
                 lastLogin: firebase.firestore.FieldValue.serverTimestamp()
              }, { merge: true }); // Use merge to avoid overwriting username etc.
            showMessage('Welcome back! Redirecting…','success');
          }
          setTimeout(()=> window.location.href='dashboard.html',1500);
        } catch(err) { handleAuthError(err); }
      });

      // AUTH STATE & verification
      auth.onAuthStateChanged(async user => {
        if (user) {
            const userDocRef = db.collection('users').doc(user.uid);
            const userDoc = await userDocRef.get();

            if (user.emailVerified) {
                // Email is verified
                // Check if the user document needs to be updated with username and verified status
                if (!userDoc.exists || userDoc.data().requiresVerification === true || !userDoc.data().username) {
                    // User document needs updating (e.g., after email/password verification)
                    // Fetch username from 'usernames' collection
                    const usernameDoc = await db.collection('usernames').where('uid', '==', user.uid).limit(1).get();
                    if (!usernameDoc.empty) {
                        const username = usernameDoc.docs[0].id; // Username is the document ID

                        // Save/update user data in 'users' collection with the username and verified status
                        await saveUserDataToUsers(user, username);

                        console.log("User verified and data saved/updated in 'users' collection.");

                        // If on signup page, redirect to dashboard after verification is processed
                        if (window.location.pathname.includes('signup.html')) {
                            showMessage('Email verified! Redirecting…','success');
                            setTimeout(()=> window.location.href='dashboard.html',1500);
                        }

                    } else {
                        console.error("Error: User verified, but username not found in 'usernames' collection for UID:", user.uid);
                        // This is an unexpected state. User exists and is verified, but username mapping is missing.
                        // Handle this edge case (e.g., prompt user to set username, contact support).
                         if (window.location.pathname.includes('signup.html')) {
                            showMessage('Error: Could not find your username. Please contact support.', 'error');
                         }
                    }
                } else {
                    // User document exists, is verified, and has username.
                    // If on signup page, redirect to dashboard as they are already fully signed up.
                    if (window.location.pathname.includes('signup.html')) {
                        showMessage('Already logged in and verified. Redirecting…','success');
                        setTimeout(()=> window.location.href='dashboard.html',1500);
                    }
                }
            } else {
                // Email is NOT verified
                // If on signup page, show message prompting verification
                if (window.location.pathname.includes('signup.html')) {
                    showMessage('Please verify your email address to complete sign up.', 'warning');
                }
                // If on other protected pages, they will be redirected by the listener on those pages.
            }
        } else {
            // User is not logged in
            // If on a protected page (like dashboard, chats, friends), they will be redirected by the listener on those pages.
            // If on signup/login/index, this is the expected state.
        }
      });

      // mark older accounts (from previous snippet, keep if needed)
      // This block runs once when the script loads.
      // It's intended to mark existing users created before a certain date as not requiring email verification.
      // Be cautious if this logic should run on every page load for every user.
      // Given the user's prompt is about the signup flow for *new* users needing verification,
      // this block is less critical to the core request but included as it was in the provided HTML.
      (async ()=>{
           // Check if Firebase app is initialized before accessing db
           if (!firebase.apps.length) return;

           // Attempt to get current user, but this block runs during initial script load
           // before auth state is fully determined. Consider moving this logic if it
           // relies on a fully authenticated user or should run only once ever.
           // For now, let's assume it's a background task to update older records.
           // It might cause permission errors if security rules prevent unauthenticated reads/writes to 'users'.
           // Add a check if auth is ready and if a user is logged in if necessary.
           // Or better, run this type of migration logic via a Cloud Function or Admin SDK script once.
           // For the purpose of this HTML file, it's likely okay as is, but noted as potential area for review.

        const older = await db.collection('users').where('createdAt','<',new Date(VERIFICATION_REQUIREMENT_DATE)).get();
        const batch = db.batch();
        older.forEach(d=> {
            // Only update if requiresVerification is not explicitly false already
            if (d.data().requiresVerification !== false) {
              batch.update(d.ref,{ requiresVerification:false, emailVerified:d.data().emailVerified!==undefined?d.data().emailVerified:true });
            }
        });
        if (!older.empty) {
          await batch.commit();
          console.log("Marked older accounts as not requiring verification.");
        }
      })();
    });
  </script>
</body>
</html>
